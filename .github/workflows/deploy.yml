name: Deploy CI/CD

on:
  push:
    branches: [ "master" ]  # masterì— pushí•  ë•Œ ì‹¤í–‰ë¨

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      FRONT_IMAGE: hamye4143/next-ecommerce-frontend
      BACK_IMAGE: hamye4143/next-ecommerce-backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Build frontend
        working-directory: client
        run: |
          npm ci
          npm run build
          docker build -t $FRONT_IMAGE -f Dockerfile .

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'corretto'
          java-version: 17

      - name: Build backend
        working-directory: back
        run: |
          ./gradlew clean bootJar -x test
          cp build/libs/app.jar app.jar
          docker build -t $BACK_IMAGE -f Dockerfile .

      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push Docker images
        run: |
          docker push $FRONT_IMAGE
          docker push $BACK_IMAGE

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: FRONT_IMAGE,BACK_IMAGE
          script: |
            # ìµœì‹  ì½”ë“œ ë°›ì•„ì˜¤ê¸° (docker-compose.yml ë°˜ì˜)
            cd ~/next-ecommerce
            git pull origin master  # master ë¸Œëœì¹˜ ê¸°ì¤€ ìµœì‹  ì½”ë“œ ë°˜ì˜
            
            echo "ğŸ§¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ (ë³¼ë¥¨ì€ ìœ ì§€)"
            docker-compose -f docker-compose.yml down
            
            echo "ğŸ§ª í˜„ì¬ ë³¼ë¥¨ ìƒíƒœ í™•ì¸"
            docker volume ls | grep db-data || echo "âš ï¸ db-data ë³¼ë¥¨ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
            
            # ì´ë¯¸ì§€, ë„¤íŠ¸ì›Œí¬, dangling ì»¨í…Œì´ë„ˆ ì •ë¦¬ (ë³¼ë¥¨ì€ ê±´ë“¤ì§€ ì•ŠìŒ)
            docker system prune -f
            
            #  ìµœì‹  ì´ë¯¸ì§€ ë°›ê¸°
            docker pull $FRONT_IMAGE
            docker pull $BACK_IMAGE
            
            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            FRONT_IMAGE=$FRONT_IMAGE BACK_IMAGE=$BACK_IMAGE docker-compose -f ~/next-ecommerce/docker-compose.yml up -d
