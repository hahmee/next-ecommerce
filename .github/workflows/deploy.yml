name: Deploy CI/CD

on:
  push:
    branches: [ "master" ]  # master에 push할 때 실행됨

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      FRONT_IMAGE: hamye4143/next-ecommerce-frontend
      BACK_IMAGE: hamye4143/next-ecommerce-backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Build frontend
        working-directory: client
        run: |
          npm ci
          npm run build
          docker build -t $FRONT_IMAGE -f Dockerfile .

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'corretto'
          java-version: 17

      - name: Build backend
        working-directory: back
        run: |
          ./gradlew clean build -x test
          cp $(find build/libs -name "*.jar" | head -n 1) app.jar

          docker build -t $BACK_IMAGE -f Dockerfile .

      - name: Docker Hub 로그인
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push Docker images
        run: |
          docker push $FRONT_IMAGE
          docker push $BACK_IMAGE

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: FRONT_IMAGE,BACK_IMAGE
          script: |
            docker-compose -f ~/next-ecommerce/docker-compose.yml down
            docker system prune -f
            docker pull $FRONT_IMAGE
            docker pull $BACK_IMAGE
            FRONT_IMAGE=$FRONT_IMAGE BACK_IMAGE=$BACK_IMAGE docker-compose -f ~/next-ecommerce/docker-compose.yml up -d
